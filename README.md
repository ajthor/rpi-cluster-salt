# Raspberry Pi Omega Salt Provisioner

In order to maintain the Raspberry Pi cluster.

## Setting up the Raspberry Pi Cluster

Setting up the Raspberry Pi nodes is pretty straightforward. Follow the instructions on [Raspberry Pi's Website](https://www.raspberrypi.org/documentation/) to install the latest version of Raspbian.

After you flash the SD card, you will need to perform three steps to get the Raspberry Pi ready for use.

1. __Enable SSH.__ To enable SSH, you will need to navigate to the SD Card directory on your computer. For Mac, it is usually located at `/Volumes/boot`. Once there, run the command `touch ssh`. This will create a blank file on the SD Card that tells the Pi to enable SSH the next time it boots.
2. __Configure WiFi.__ If you are going to connect your Raspberry Pi via ethernet, you can skip this step. To set up WiFi, you will need to create a file on the SD Card called `wpa_supplicant.conf`. To do this, you will use the command `sudo nano wpa_supplicant.conf` and add the lines below to the file. Be sure to change 'my_ssid' to the SSID of your network. The 'psk' can be generated by running `wpa_passphrase [my_ssid] [password]`. If you use `wpa_passphrase`, you can copy and paste the output of that command directly into the `wpa_supplicant.conf` file. More thorough instructions can be found [here](https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md).
    ```
    country=US
    ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
    update_config=1

    network={
      ssid="my_ssid"
      psk=131e1e221f6e06e3911a2d11ff2fac9182665c004de85300f9cac208a6a80531
    }
    ```
3. __Change the Hostname.__ Lastly, we need to change the host name of the device. Insert the SD Card into the Raspberry Pi and boot it up. This can take up to 90 seconds. Once you have done so, SSH into the node using the IP address of the Raspberry Pi. If you are connected via USB, you can use `ssh pi@raspberrypi.local`. The default password is `raspberry`. Now, we need to change the hostname of the Pi. The easiest way to achieve this is using the command `sudo raspi-config` and following the on-screen instructions to change it. For the 'master', use `raspiomega-master`, and for each 'node', use `raspiomega-node-[#]`, where the '[#]' is replaced by a unique number for each node. You can also change the password if you choose.

From this point on, the nodes can be set up using the SaltStack provisioner. However, you will need to set up the Master using the instructions below.

---

## Setting up the Master

First and foremost in this cluster, we need to set up the Master. The master node is the only node that needs to be set up manually, every other node can be set up using salt-ssh.

### Using the Salt Bootstrap Script

To install the latest version of Salt, we can take advantage of the Salt bootstrap script available to us from the wonderful developers at SaltStack. On the Master, run `curl -o /tmp/bootstrap-salt.sh -L https://bootstrap.saltstack.com` to download the install script into the `tmp` directory. Once the file is downloaded, you can run the script using `sudo sh /tmp/bootstrap-salt.sh -M` to install the latest version of salt-minion and salt-master for Raspbian. The bootstrap script will install salt-minion automatically, and by adding the `-M` tag, we can elect to install salt-master, as well. Additionally, if you want to keep the Master separate from the cluster, you can use the `-N` flag to skip installing salt-minion on the Master.

More instructions for setting up Salt on the Master can be found at [Salt Bootstrap](https://docs.saltstack.com/en/latest/topics/tutorials/salt_bootstrap.html#debian-and-derivatives) and [Raspbian Install Documentation](https://docs.saltstack.com/en/latest/topics/installation/debian.html).

From here, if you want to configure nodes using salt-ssh, you can run `sudo apt-get install salt-ssh`. That's it! Once you are finished, you have successfully installed Salt on the RPiOmega Master.

### Setting up the Git File Server

The easiest way to maintain the latest configuration for the Salt Master is to use GitFS in place of the regular filesystem for Salt. This allows you to keep your Salt configuration in a Git repo, as opposed to on your local Salt Master.

To start, you will need a python library for interacting with Git, such as *pygit2*, *GitPython*, or *Dulwich*.

As of 3/14/17, pygit2 is not packaged for Raspbian, though you can install it from source. GitPython and Dulwich have an updated source for Raspbian, and can be installed using `apt-get install python-git` or `apt-get install python-dulwich`.

Next, you will need configure the Master to use Git as the fileserver. To do this, you will need to modify `/etc/salt/master` and change the file with the following configuration changes:

```
fileserver_backend:
  - git

gitfs_remotes:
  - https://github.com/ajthor/rpiomega-salt.git
```

If you create your own configuration for the cluster, either by forking this repository or by creating your own git repo to hold your cluster configuration, be sure to change the remote repo. If you only want to change a small portion of the configuration, you can add your own git repo in place of (or above) the first repo in the configuration file. Salt will pull from the list in order, so if there are two files with the same name, the file from the first repo in the list takes precedence.

Take a look at [Git Fileserver Backend Walkthrough](https://docs.saltstack.com/en/latest/topics/tutorials/gitfs.html#gitfs-per-remote-config) for more info.

If you want to have a local configuration, that's fine, too! Take a look at the [Salt Documentation](https://docs.saltstack.com/en/latest/topics/tutorials/states_pt1.html) for more information on configuring Salt.

---

## Bootstrapping Nodes

Next, we need to install `salt-minion` on each node. This can be done a number of ways:

- (Recommended) Install `salt-minion` using salt-ssh from the master.
- Install `salt-minion` manually, following the instructions on the [Salt Website](https://docs.saltstack.com/en/latest/topics/installation/debian.html) or by using the [bootstrap script](#using-the-salt-bootstrap-script).

### Install Salt via salt-ssh

If you choose to install `salt-minion` using salt-ssh, you can install salt-minion via the bootstrap script directly from the master node.

To do this, we first need to edit the roster file on `rpiomega-master` located at `/etc/salt/roster`. Edit the file to include the Raspberry Pi nodes by adding each node as shown below:

```
rpiomega-node-1:
  host: rpiomega-node-[#]
  user: pi
  passwd: raspberry
  sudo: True
```

NOTE: If the nodes have a static IP address, you can replace the 'host' with the static IP instead of the hostname you gave the node.

Once you have added the Raspberry Pi node to the roster file, you can install Salt on the nodes using the bootstrap command from earlier: `salt-ssh [raspiomega-node-#] -r 'curl -L https://bootstrap.saltstack.com | sudo sh'`. Make sure to replace '#' with the number of the node you are installing Salt on.
